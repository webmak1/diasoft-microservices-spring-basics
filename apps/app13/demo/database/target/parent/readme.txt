		Инструкция по инициализации и обновлению базы данных под "Платформу DigitalQ"
	
	Предварительные условия и требования.

1. Для инициализации базы данных Вам необходимо установить один из поддерживаемых серверов баз данных:
	* MS SQL Server 2008 - 2016
	* Oracle 11g, 12c
	* PostgreSQL 9.5, 10.4, 12.1

При установке MS SQL Server убедитесь, что выбран case insensitive collation. 
Это важно! Платформа не поддерживает работу с case sensitive collations.

2. В Oracle каждый микросервис использует собственную базу данных и пользователя для доступа к ней.
   При инициализации база данных и пользователь могут быть созданы программно, а могут быть созданы администратором вручную заранее.
   В MS SQL Server и PostgreSQL используется одна общая база данных, создаваемая администратором вручную.
   Каждый микросервис при этом использует собственную схему в указанной базе данных и пользователя для доступа к указанной схеме.
   При инициализации схема и пользователь могут быть созданы программно, а могут быть созданы администратором вручную заранее.

   Для программного создания базы данных и пользователя в случае Oracle или схемы базы данных и пользователя (а также их удаления при необходимости)
   Вам необходимо знать логин и пароль администратора БД, он должен обладать ролью db_owner.

3. Перед обновлением базы данных рекомендуется сделать полный бекап всех данных.
	
4. Пользователь на Oracle должен иметь права на execute DBMS_LOCK (если пользователь создается Администратором БД, то он должен иметь право раздавать эту привилегию на объект).

5. Порядок действий

Для инициализации базы данных под "Платформу DigitalQ" запустите файл dm.bat (или dm.sh в операционной системе linux)
Формат комадной строки:

	dm.bat [commands] [options]

Скрипт инициализации понимает следующие команды:

	-d или drop - удаляет существующую базу данных (Oracle) или схему базы данных (MS SQL Server и PostgreSQL)
	-c или create - создает базу данных и пользователя (Oracle) или схему и пользователя (MS SQL Server и PostgreSQL)
	-i или init - инициализирует базу данных (создает таблицы, индексы и т.п.)
	-u или update - обновляет структуру БД до текущей версии. 
	-v или validate - проверяет соответствие структуры БД текущей версии. Эта команда действует по умолчанию.
		
Скрипту инициализации необходимо передавать следующие опции:
			
	--url=<url> - задает JDBC URL для доступа к БД
	--driver=<driverClassname> - задает имя класса JDBC драйвера для доступа к БД (можно не указывать для поддерживаемых)
	--username=<username> - задает имя пользователя, который будет создан и которого следует использовать для соединения с БД 		
	--password=<password> - задает пароль пользователя, по умолчанию: совпадает с именем пользователя
	--admin=<username> - задет имя суперпользователя, у которого есть права на создание баз данных, таблиц и т.п.
	--adminPassword=<password> - задает пароль суперпользователя.
	--database=<databaseName> - задает имя базы данных для создания, удаления, проверки или инициализации (для Oracle имя базы данных = имя схемы = имя пользователя)
	--schema=<schemaName> - задает имя схемы базы данных (для MS SQL Server и PostgreSQL)
	--sqlFile=<file> - задает имя файла, в который будет записан SQL скрипт для выполнения. БД изменена не будет.
	--sqlFileEncoding=<encoding> - кодировка для файла с SQL скриптом, по умолчанию используется кодировка UTF-8 	
	--logLevel=<all|finest|finer|fine|info|warning|severe|off> - задает уровень логирования
	--logFile=<file> - задает имя файла для сохранения логов. По умолчанию логи выводятся на консоль.
	--locale=<locale> - задает альфа-код локали для установки дистрибутивных данные (по умолчанию ru)
	-Dmastername=<sys> - имя схемы для MSSQL, необходимо указать если имя отлично от sys, в базе master(например -Dmastername=dbo)
	-Ddefaulttablespace=<users> - табличное пространство по умолчанию для Oracle, необходимо указать, если имя отлично от users (например -Ddefaulttablespace=myuser)
	-Dtemptablespace=<temp> - табличное пространство временных сегментов для Oracle, необходимо указать, если имя отлично от temp (например -Dtemptablespace=mytemp)
	-D<propertyName>=<propertyValue> - задают дополнительные параметры, необходимые для инициализации или обновления БД

В случае успешной работы скрипта, в конце Вы получите соответствующее сообщение.
Иначе Вы получите сообщение об ошибке.

6. Примеры.
	
Oracle:
	
	Создать и проинициализировать базу данных "с нуля", если БД уже существует, удалить ее:

	dm.bat -d -c -i --url=jdbc:oracle:thin:@OracleHost:1521:OracleSID --database=example1 --username=example --password=examplepass  --admin=system --adminPassword=secret
	
	Обновить существующую БД до текущей версии:
	
	dm.bat -u --url=jdbc:oracle:thin:@OracleHost:1521:OracleSID --database=example1 --username=example --password=examplepass

* Обратите внимание что в Oracle имя пользователя и имя БД есть суть одно и тоже, 
поэтому опция username не имеет силы, программа создаст пользователя с именем заданным опцией database.

* Обратие внимание что для Orcale для создания базы логин admin должен обладать административными правами, 
	но не быть равным SYS 

MSSQL:

	Создать и проинициализировать схему базы данных "с нуля", если схема БД уже существует, удалить ее:
	
	dm.bat -d -c -i --url=jdbc:jtds:sqlserver://MSSQLHost:1433 --database=example1 --schema=example2 --username=exowner1 --password=exownerpass1 --admin=sa --adminPassword=secret  -Dmastername=dbo
	
	Обновить существующую БД до текущей версии:

	dm.bat -u --url=jdbc:jtds:sqlserver://MSSQLHost:1433/example1 --database=example1 --schema=example2 --username=sa --password=secret 	

* Обратите внимание, что создание БД выполняется заранее администратором.

PostgreSQL:

	Создать и проинициализировать схему базы данных "с нуля", если БД уже существует, удалить ее:
	
	dm.bat -d -c -i --url=jdbc:postgresql://PostgreSQLHost:5432 --database=example1 --schema=example2 --username=exowner1 --password=exownerpass1 --admin=postgres --adminPassword=secret --driver=org.postgresql.Driver

	Проинициализировать схему БД "с нуля"*:

	dm.bat -i --url=jdbc:postgresql://PostgreSQLHost:5432 --database=example1 --schema=example2 --username=exowner1 --password=exownerpass1 --driver=org.postgresql.Driver

	Обновить существующую схему БД до текущей версии:

	dm.bat -u --url=jdbc:postgresql://PostgreSQLHost:5432 --database=example1 --schema=example2 --username=exowner1 --password=exownerpass1 --driver=org.postgresql.Driver

* Обратите внимание, что наименование базы данных, схемы и логина пользователя должны быть заданы в нижнем регистре

* Обратите внимание, что создание БД выполняется заранее администратором.

* Обратите внимание, что для создания и удаления схемы БД и пользователя необходимы данные администратора (admin и adminPassword).
  Если схема БД и пользователь созданы администратором заранее, то для создания элементов схемы (таблицы, индексы, хранимые процедуры и функции)
  достаточно выполнить команду инициализации (-i) или обновления (-u)
